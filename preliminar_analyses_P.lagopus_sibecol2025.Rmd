---
title: "DEFENSIVE TRAITS P.lagopus SIBECOL 2025"
author: "Andrés Delgado Galán"
date: "2025-05-18"
output:
  html_document: default
  pdf_document: default
---

```{r LOADING DATA AND PACKAGES, include=FALSE}

library(dplyr)
library(DHARMa)
library(ggplot2)
library(ggeffects)
library(cowplot)
library(kableExtra)
library(tibble)
library(knitr)
library(emmeans)
library(car)
library(scales)

data <- read.table("rawdata/datos_sibecol_2025.csv", header = TRUE, sep = ";")
datamother <- read.table("rawdata/seedmother.csv", header = TRUE, sep = ";")
```

```{r PRE-ANALYSIS Data PREPARATION, include=FALSE}
#hacemos una matriz para para la especie PL
PLdata <- data |> filter(sp == "PL")
```

```{r PREPARING A PLOTTING FUNCTION, include=FALSE}
# Define color palettes
custom_colors <- c("Grazed" = "#FF10F0", "Ungrazed" = "#006400")
lighter_colors <- c("Grazed" = alpha("#FF10F0", 0.3), "Ungrazed" = alpha("#006400", 0.3))

# Named vectors for relabeling
trat_labels <- c("gra" = "Grazed", "ex" = "Ungrazed")
clip_labels <- c("yes" = "Damaged", "no" = "Undamaged")

# Prepare your data once
PLdata <- PLdata %>%
  mutate(
    trat_label = factor(trat_labels[as.character(trat)], levels = c("Ungrazed", "Grazed")),
    clip_label = factor(clip_labels[as.character(clip)], levels = c("Undamaged", "Damaged"))
  )

# Define a reusable plotting function
plot_PL_variable <- function(data, response_var) {
  ggplot(data, aes(x = trat_label, y = {{ response_var }})) +
    
    # Boxplot
    geom_boxplot(
      aes(color = trat_label),
      fill = NA,
      size = 1,
      width = 0.5
    ) +
    
    # Violin for Undamaged (filled)
    geom_violin(
      data = filter(data, clip_label == "Undamaged"),
      aes(
        fill = trat_label,
        group = interaction(trat_label, clip_label),
        linetype = clip_label
      ),
      color = NA,
      alpha = 0.2,
      width = 0.5,
      scale = "area"
    ) +
    
    # Violin for Damaged (outline)
    geom_violin(
      data = filter(data, clip_label == "Damaged"),
      aes(
        color = trat_label,
        group = interaction(trat_label, clip_label),
        linetype = clip_label
      ),
      fill = NA,
      alpha = 0.2,
      size = 0.8,
      width = 0.5,
      scale = "area"
    ) +
    
    scale_color_manual(values = custom_colors, guide = "none") +
    scale_fill_manual(values = custom_colors, guide = "none") +
    scale_linetype_manual(
      values = c("Undamaged" = "solid", "Damaged" = "dashed"),
      name = NULL
    ) +
    
    labs(
      x = "Maternal Environment",
      y = as_label(enquo(response_var)),
      linetype = "Herbivory Simulation"
    ) +
    theme_minimal() +
    theme(
      legend.title = element_blank(),
      legend.position = "right"
    )
}

```


### P.lagopus - PRODUCCIÓN DE FLORES

```{r PLflor Model, include=FALSE}
#filtramos las filas con datos de nº de flores
PLdata.flor <- subset(PLdata, !is.na(flor))
plot(density(PLdata.flor$flor))
# AS THERE ARE MANY 0s, WE WILL REMOVE 0s also
PLdata.flor <- subset(PLdata.flor, flor != 0)

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLflormodel <- lm(sqrt(flor) ~ trat + clip + trat:clip, data = PLdata.flor, na.action = na.fail)

sample_size <- nrow(PLdata.flor)
# Extract the formula from the model
model_formula <- formula(PLflormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`** (muchos 0s quitados)

```{r DHARMA PLflor: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLflormodel)
plot(residuals)
```

```{r SUMMARY OF PLflor MODEL, include=FALSE}
summary <- summary(PLflormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLflor MODEL, include=FALSE}
anova_flor <- Anova(PLflormodel, type = 2, test.statistic = "F")
anova_flor
```

```{r PLflor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLflormodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLflormodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLflor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLflor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLflor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_flor %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL flor"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLflor Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata.flor, flor)

```

### P.lagopus - PRODUCCIÓN DE FRUTOS

```{r PLfruto Model, include=FALSE}
#filtramos las filas con datos de nº de frutoes
PLdata.fruto <- subset(PLdata, !is.na(fruto))
# AS THERE ARE MANY 0s, WE WILL REMOVE 0s also
PLdata.fruto <- subset(PLdata.fruto, fruto != 0)

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLfrutomodel <- lm(log(fruto) ~ trat + clip + trat:clip, data = PLdata.fruto, na.action = na.fail)

sample_size <- nrow(PLdata.fruto)
# Extract the formula from the model
model_formula <- formula(PLfrutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`** (muchos 0s quitados)

```{r DHARMA PLfruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLfrutomodel)
plot(residuals)
```

```{r SUMMARY OF PLfruto MODEL, include=FALSE}
summary <- summary(PLfrutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLfruto MODEL, include=FALSE}
anova_fruto <- Anova(PLfrutomodel, type = 2, test.statistic = "F")
anova_fruto
```

```{r PLfruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLfrutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLfrutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLfruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_fruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL fruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLfruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata.fruto, fruto)

```

### P.lagopus - PRODUCCIÓN DE HOJAS

```{r PLhojas Model, include=FALSE}
#filtramos las filas con datos de nº de hojases
PLdata.hojas <- subset(PLdata, !is.na(hojas))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLhojasmodel <- lm(sqrt(hojas) ~ trat + clip + trat:clip, data = PLdata.hojas, na.action = na.fail)

sample_size <- nrow(PLdata.hojas)
# Extract the formula from the model
model_formula <- formula(PLhojasmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLhojas: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLhojasmodel)
plot(residuals)
```

```{r SUMMARY OF PLhojas MODEL, include=FALSE}
summary <- summary(PLhojasmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLhojas MODEL, include=FALSE}
anova_hojas <- Anova(PLhojasmodel, type = 2, test.statistic = "F")
anova_hojas
```

```{r PLhojas Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLhojasmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLhojasmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLhojas Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLhojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLhojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_hojas %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL hojas"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLhojas Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL hojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, hojas)
```

### P.lagopus - ALTURA MÁXIMA

```{r PLaltura Model, include=FALSE}
#filtramos las filas con datos de nº de alturaes
PLdata.altura <- subset(PLdata, !is.na(altura))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLalturamodel <- lm(sqrt(altura) ~ trat + clip + trat:clip, data = PLdata.altura, na.action = na.fail)

sample_size <- nrow(PLdata.altura)
# Extract the formula from the model
model_formula <- formula(PLalturamodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLaltura: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLalturamodel)
plot(residuals)
```

```{r SUMMARY OF PLaltura MODEL, include=FALSE}
summary <- summary(PLalturamodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLaltura MODEL, include=FALSE}
anova_altura <- Anova(PLalturamodel, type = 2, test.statistic = "F")
anova_altura
```

```{r PLaltura Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLalturamodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLalturamodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLaltura Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLaltura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLaltura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_altura %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL altura"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLaltura Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL altura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, altura)


```

### P.lagopus - SEMILLAS/FRUTO

```{r PLseedfruto Model, include=FALSE}
#filtramos las filas con datos de nº de seedfrutoes
PLdata.seedfruto <- subset(PLdata, !is.na(seedfruto))
PLdata.seedfruto$seedfruto

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLseedfrutomodel <- lm(sqrt(seedfruto) ~ trat + clip + trat:clip, data = PLdata.seedfruto, na.action = na.fail)

sample_size <- nrow(PLdata.seedfruto)
# Extract the formula from the model
model_formula <- formula(PLseedfrutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLseedfruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLseedfrutomodel)
plot(residuals)
```

```{r SUMMARY OF PLseedfruto MODEL, include=FALSE}
summary <- summary(PLseedfrutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLseedfruto MODEL, include=FALSE}
anova_seedfruto <- Anova(PLseedfrutomodel, type = 2, test.statistic = "F")
anova_seedfruto
```

```{r PLseedfruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLseedfrutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLseedfrutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLseedfruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLseedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLseedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_seedfruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL seedfruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLseedfruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL seedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, seedfruto)

```

### P.lagopus - PRODUCCIÓN DE SEMILLAS

```{r PLseedtotal Model, include=FALSE}
#filtramos las filas con datos de nº de seedtotales
PLdata.seedtotal <- subset(PLdata, !is.na(seedtotal))
# AS THERE ARE MANY 0s, WE WILL REMOVE 0s also
PLdata.seedtotal <- subset(PLdata.seedtotal, seedtotal != 0)

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLseedtotalmodel <- lm(sqrt(seedtotal) ~ trat + clip + trat:clip, data = PLdata.seedtotal, na.action = na.fail)

sample_size <- nrow(PLdata.seedtotal)
# Extract the formula from the model
model_formula <- formula(PLseedtotalmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLseedtotal: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLseedtotalmodel)
plot(residuals)
```

```{r SUMMARY OF PLseedtotal MODEL, include=FALSE}
summary <- summary(PLseedtotalmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLseedtotal MODEL, include=FALSE}
anova_seedtotal <- Anova(PLseedtotalmodel, type = 2, test.statistic = "F")
anova_seedtotal
```

```{r PLseedtotal Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLseedtotalmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLseedtotalmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLseedtotal Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLseedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLseedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_seedtotal %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL seedtotal"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLseedtotal Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL seedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata.seedtotal, seedtotal)

```

### P.lagopus - PESO MEDIO DE LAS SEMILLAS

```{r PLmassseed Model, include=FALSE}
#filtramos las filas con datos de nº de massseedes
PLdata.massseed <- subset(PLdata, !is.na(massseed))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLmassseedmodel <- lm(sqrt(massseed) ~ trat + clip + trat:clip, data = PLdata.massseed, na.action = na.fail)

sample_size <- nrow(PLdata.massseed)
# Extract the formula from the model
model_formula <- formula(PLmassseedmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLmassseed: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLmassseedmodel)
plot(residuals)
```

```{r SUMMARY OF PLmassseed MODEL, include=FALSE}
summary <- summary(PLmassseedmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLmassseed MODEL, include=FALSE}
anova_massseed <- Anova(PLmassseedmodel, type = 2, test.statistic = "F")
anova_massseed
```

```{r PLmassseed Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLmassseedmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLmassseedmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLmassseed Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLmassseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLmassseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_massseed %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL massseed"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLmassseed Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL massseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, massseed)
```

### P.lagopus - SLA

```{r PLSLA Model, include=FALSE}
#filtramos las filas con datos de nº de SLAes
PLdata.SLA <- subset(PLdata, !is.na(SLA))
# Find the row with the highest SLA value (OUTLIER)
max_row <- PLdata.SLA[which.max(PLdata.SLA$SLA), ]
#REMOVING AN EXTREME VALUE OF SLA
PLdata.SLA <- PLdata.SLA[PLdata.SLA$id!= 35, ]

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLSLAmodel <- lm(log(SLA) ~ trat + clip + trat:clip, data = PLdata.SLA, na.action = na.fail)

sample_size <- nrow(PLdata.SLA)
# Extract the formula from the model
model_formula <- formula(PLSLAmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLSLA: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLSLAmodel)
plot(residuals)
```

```{r SUMMARY OF PLSLA MODEL, include=FALSE}
summary <- summary(PLSLAmodel)
summary
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLSLA MODEL, include=FALSE}
anova_SLA <- Anova(PLSLAmodel, type = 2, test.statistic = "F")
anova_SLA
```

```{r PLSLA Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLSLAmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLSLAmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLSLA Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLSLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLSLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_SLA %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL SLA"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLSLA Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL SLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata.SLA, SLA)

```

### P.lagopus - LDMC

```{r PLLDMC Model, include=FALSE}
#filtramos las filas con datos de nº de LDMCes
PLdata.LDMC <- subset(PLdata, !is.na(LDMC))



#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLLDMCmodel <- lm(sqrt(LDMC) ~ trat + clip + trat:clip, data = PLdata.LDMC, na.action = na.fail)

sample_size <- nrow(PLdata.LDMC)
# Extract the formula from the model
model_formula <- formula(PLLDMCmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLLDMC: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLLDMCmodel)
plot(residuals)
```

```{r SUMMARY OF PLLDMC MODEL, include=FALSE}
summary <- summary(PLLDMCmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLLDMC MODEL, include=FALSE}
anova_LDMC <- Anova(PLLDMCmodel, type = 2, test.statistic = "F")
anova_LDMC
```

```{r PLLDMC Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLLDMCmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLLDMCmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLLDMC Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLLDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLLDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_LDMC %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL LDMC"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLLDMC Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL LDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, LDMC)
```

### P.lagopus - ÁREA FOLIAR

```{r PLarea.m Model, include=FALSE}
#filtramos las filas con datos de nº de area.mes
PLdata.area.m <- subset(PLdata, !is.na(area.m))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLarea.mmodel <- lm(sqrt(area.m) ~ trat + clip + trat:clip, data = PLdata.area.m, na.action = na.fail)

sample_size <- nrow(PLdata.area.m)
# Extract the formula from the model
model_formula <- formula(PLarea.mmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLarea.m: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLarea.mmodel)
plot(residuals)
```

```{r SUMMARY OF PLarea.m MODEL, include=FALSE}
summary <- summary(PLarea.mmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLarea.m MODEL, include=FALSE}
anova_area.m <- Anova(PLarea.mmodel, type = 2, test.statistic = "F")
anova_area.m
```

```{r PLarea.m Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLarea.mmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLarea.mmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLarea.m Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLarea.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLarea.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_area.m %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL area.m"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLarea.m Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL area.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, area.m)
```

### P.lagopus - TASA FOTOSINTÉTICA

```{r PLPhotosyn Model, include=FALSE}
#filtramos las filas con datos de nº de Photosynes
PLdata.Photosyn <- subset(PLdata, !is.na(Photosyn))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLPhotosynmodel <- lm(sqrt(Photosyn) ~ trat + clip + trat:clip, data = PLdata.Photosyn, na.action = na.fail)

sample_size <- nrow(PLdata.Photosyn)
# Extract the formula from the model
model_formula <- formula(PLPhotosynmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLPhotosyn: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLPhotosynmodel)
plot(residuals)
```

```{r SUMMARY OF PLPhotosyn MODEL, include=FALSE}
summary <- summary(PLPhotosynmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLPhotosyn MODEL, include=FALSE}
anova_Photosyn <- Anova(PLPhotosynmodel, type = 2, test.statistic = "F")
anova_Photosyn
```

```{r PLPhotosyn Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLPhotosynmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLPhotosynmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLPhotosyn Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLPhotosyn, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLPhotosyn, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_Photosyn %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL Photosyn"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLPhotosyn Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL Photosyn, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, Photosyn)

```

### P.lagopus - CONDUCTANCIA ESTOMÁTICA

```{r PLConductance Model, include=FALSE}
#filtramos las filas con datos de nº de Conductancees
PLdata.Conductance <- subset(PLdata, !is.na(Conductance))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLConductancemodel <- lm(sqrt(Conductance) ~ trat + clip + trat:clip, data = PLdata.Conductance, na.action = na.fail)

sample_size <- nrow(PLdata.Conductance)
# Extract the formula from the model
model_formula <- formula(PLConductancemodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLConductance: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLConductancemodel)
plot(residuals)
```

```{r SUMMARY OF PLConductance MODEL, include=FALSE}
summary <- summary(PLConductancemodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLConductance MODEL, include=FALSE}
anova_Conductance <- Anova(PLConductancemodel, type = 2, test.statistic = "F")
anova_Conductance
```

```{r PLConductance Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLConductancemodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLConductancemodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLConductance Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLConductance, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLConductance, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_Conductance %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL Conductance"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLConductance Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL Conductance, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, Conductance)

```

### P.lagopus - EFICIENCIA DEL FOTOSISTEMA II

```{r PLPhiPS2 Model, include=FALSE}
#filtramos las filas con datos de nº de PhiPS2es
PLdata.PhiPS2 <- subset(PLdata, !is.na(PhiPS2))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLPhiPS2model <- lm(log(PhiPS2) ~ trat + clip + trat:clip, data = PLdata.PhiPS2, na.action = na.fail)

sample_size <- nrow(PLdata.PhiPS2)
# Extract the formula from the model
model_formula <- formula(PLPhiPS2model)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLPhiPS2: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLPhiPS2model)
plot(residuals)
```

```{r SUMMARY OF PLPhiPS2 MODEL, include=FALSE}
summary <- summary(PLPhiPS2model)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLPhiPS2 MODEL, include=FALSE}
anova_PhiPS2 <- Anova(PLPhiPS2model, type = 2, test.statistic = "F")
anova_PhiPS2
```

```{r PLPhiPS2 Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLPhiPS2model, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLPhiPS2model, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLPhiPS2 Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLPhiPS2, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLPhiPS2, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_PhiPS2 %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL PhiPS2"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLPhiPS2 Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL PhiPS2, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, PhiPS2)

```

### P.lagopus - FENOLOGÍA DE FLORACIÓN

```{r PLdias_flor Model, include=FALSE}
#filtramos las filas con datos de nº de dias_flores
PLdata.dias_flor <- subset(PLdata, !is.na(dias_flor))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLdias_flormodel <- lm(sqrt(dias_flor) ~ trat + clip + trat:clip, data = PLdata.dias_flor, na.action = na.fail)

sample_size <- nrow(PLdata.dias_flor)
sample_size
# Extract the formula from the model
model_formula <- formula(PLdias_flormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLdias_flor: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLdias_flormodel)
plot(residuals)
```

```{r SUMMARY OF PLdias_flor MODEL, include=FALSE}
summary <- summary(PLdias_flormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLdias_flor MODEL, include=FALSE}
anova_dias_flor <- Anova(PLdias_flormodel, type = 2, test.statistic = "F")
anova_dias_flor
```

```{r PLdias_flor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLdias_flormodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLdias_flormodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLdias_flor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLdias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLdias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_flor %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL dias_flor"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLdias_flor Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL dias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, dias_flor)

```

### P.lagopus - FENOLOGÍA DE FRUCTIFICACÓN

```{r PLdias_fruto Model, include=FALSE}
#filtramos las filas con datos de nº de dias_frutoes
PLdata.dias_fruto <- subset(PLdata, !is.na(dias_fruto))
plot(density(PLdata.dias_fruto$dias_fruto))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLdias_frutomodel <- lm(sqrt(dias_fruto) ~ trat + clip + trat:clip, data = PLdata.dias_fruto, na.action = na.fail)

sample_size <- nrow(PLdata.dias_fruto)
sample_size
# Extract the formula from the model
model_formula <- formula(PLdias_frutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`** (no se cumple la homocedasticidad de los residuos)

```{r DHARMA PLdias_fruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLdias_frutomodel)
plot(residuals)
```

```{r SUMMARY OF PLdias_fruto MODEL, include=FALSE}
summary <- summary(PLdias_frutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLdias_fruto MODEL, include=FALSE}
anova_dias_fruto <- Anova(PLdias_frutomodel, type = 2, test.statistic = "F")
anova_dias_fruto
```

```{r PLdias_fruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLdias_frutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLdias_frutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLdias_fruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLdias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLdias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_fruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL dias_fruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLdias_fruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL dias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, dias_fruto)


```

### P.lagopus - PERIODO DE FLORACIÓN

```{r PLperiodo_flor Model, include=FALSE}
#Creamos la variable periodo_flor
PLdata$periodo_flor <- PLdata$dias_fin_flor - PLdata$dias_flor
#filtramos las filas con datos de nº de periodo_flores
PLdata.periodo_flor <- subset(PLdata, !is.na(periodo_flor))
plot(density(PLdata.periodo_flor$periodo_flor))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLperiodo_flormodel <- lm(sqrt(periodo_flor) ~ trat + clip + trat:clip, data = PLdata.periodo_flor, na.action = na.fail)#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLperiodo_flormodel <- lm(sqrt(periodo_flor) ~ trat + clip + trat:clip, data = PLdata.periodo_flor, na.action = na.fail)

sample_size <- nrow(PLdata.periodo_flor)
sample_size
# Extract the formula from the model
model_formula <- formula(PLperiodo_flormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`** no hay modelo que valga. La mayoría de plantas de esta especie ni siquiera empezaron a florecer cuando las cosechamos para la epigenética :(

```{r DHARMA PLperiodo_flor: checking residuals, echo=FALSE, fig.show='hide'}
# residuals <- simulateResiduals(fittedModel = PLperiodo_flormodel)
# plot(residuals)
```

```{r SUMMARY OF PLperiodo_flor MODEL, include=FALSE}
summary <- summary(PLperiodo_flormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLperiodo_flor MODEL, include=FALSE}
# anova_periodo_flor <- Anova(PLperiodo_flormodel, type = 2, test.statistic = "F")
# anova_periodo_flor
```

```{r PLperiodo_flor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# # This will compare treatment levels within each level of grazer
# posthoc_trat <- emmeans(PLperiodo_flormodel, pairwise ~ trat | clip, adjust = "tukey")
# print(posthoc_trat)
# 
# # This will compare grazer levels within each treatment
# posthoc_clip <- emmeans(PLperiodo_flormodel, pairwise ~ clip | trat, adjust = "tukey")
# print(posthoc_clip)
# 
# # Visualizing results
# 
# # Plot treatment differences within each grazer
# plot(posthoc_trat$emmeans)
# 
# # Plot grazer differences within each treatment
# plot(posthoc_clip$emmeans)

```

##### [PLperiodo_flor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLperiodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# kable(as.data.frame(posthoc_clip$contrasts))
# 
# kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLperiodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# # Convert the ANOVA results to a data frame and create a styled table
# 
# anova_periodo_flor %>%
#   as.data.frame() %>%
#   rownames_to_column("Predictor") %>%
#   mutate(
#     Significance = case_when(
#       `Pr(>F)` < 0.001 ~ "***",
#       `Pr(>F)` < 0.01 ~ "**",
#       `Pr(>F)` < 0.05 ~ "*",
#       `Pr(>F)` < 0.1 ~ "·",
#       TRUE ~ ""  # No asterisk for p > 0.05
#     ),
#     Predictor_with_significance = paste(Predictor, Significance, sep = " ")
#   ) %>%
#   select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
#   rename(Predictor = Predictor_with_significance) %>%  # Renames column
#   mutate(
#     # Round all numeric columns to 3 decimal points
#     across(where(is.numeric), ~ round(., 3)),
#     # Add the new column 'Response' with "Diversity" in all rows
#     Response = "PL periodo_flor"
#   ) %>%
#   select(Response, Predictor, everything()) %>%  # Moves Response to the first column
#   kable("html", caption = "ANOVA Results for PLperiodo_flor Model") %>%
#   kable_styling(
#     bootstrap_options = c("striped", "hover", "condensed"),
#     full_width = FALSE
#   ) %>%
#   column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
#   column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL periodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, periodo_flor)

```

### P.lagopus - PERIODO DE FRUCTIFICACIÓN

```{r PLperiodo_fruto Model, include=FALSE} 
#Creamos la variable periodo_fruto
PLdata$periodo_fruto <- PLdata$dias_fin_fruto - PLdata$dias_fruto
 #filtramos las filas con datos de nº de periodo_frutoes 

 PLdata.periodo_fruto <- subset(PLdata, !is.na(periodo_fruto)) 

 #probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos 

 PLperiodo_frutomodel <- lm(sqrt(periodo_fruto) ~ trat + clip + trat:clip, data = PLdata.periodo_fruto, na.action = na.fail) 

 sample_size <- nrow(PLdata.periodo_fruto) 

 # Extract the formula from the model 

 model_formula <- formula(PLperiodo_frutomodel) 

 # Convert formula to character and clean up 

 model_formula_clean <- deparse(model_formula) 

```


 **`r model_formula_clean`**\ 

 n = **`r sample_size`** 


```{r DHARMA PLperiodo_fruto: checking residuals, echo=FALSE, fig.show='hide'} 

 # residuals <- simulateResiduals(fittedModel = PLperiodo_frutomodel) 
 # 
 # plot(residuals) 

```

```{r SUMMARY OF PLperiodo_fruto MODEL, include=FALSE} 

 summary <- summary(PLperiodo_frutomodel) 

 rsq <- summary$adj.r.squared 

 rsq 

```

 R² = **`r rsq`** 

```{r ANOVA OF PLperiodo_fruto MODEL, include=FALSE} 

 # anova_periodo_fruto <- Anova(PLperiodo_frutomodel, type = 2, test.statistic = "F") 
 # 
 # anova_periodo_fruto 

```

```{r PLperiodo_fruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE} 

 # # This will compare treatment levels within each level of grazer 
 # 
 # posthoc_trat <- emmeans(PLperiodo_frutomodel, pairwise ~ trat | clip, adjust = "tukey") 
 # 
 # print(posthoc_trat) 
 # 
 # # This will compare grazer levels within each treatment 
 # 
 # posthoc_clip <- emmeans(PLperiodo_frutomodel, pairwise ~ clip | trat, adjust = "tukey") 
 # 
 # print(posthoc_clip) 
 # 
 # # Visualizing results 
 # 
 # # Plot treatment differences within each grazer 
 # 
 # plot(posthoc_trat$emmeans)   
 # 
 # # Plot grazer differences within each treatment 
 # 
 # plot(posthoc_clip$emmeans) 
 # 

```


 ##### [PLperiodo_fruto Post-hoc Comparisons with Tukeys HSD]{.underline} 

```{r Post-hoc PLperiodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 # kable(as.data.frame(posthoc_clip$contrasts)) 
 # 
 # kable(as.data.frame(posthoc_trat$contrasts)) 


```

```{r ANOVA PLperiodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 # # Convert the ANOVA results to a data frame and create a styled table 
 # 
 # anova_periodo_fruto %>% 
 # 
 #   as.data.frame() %>% 
 # 
 #   rownames_to_column("Predictor") %>% 
 # 
 #   mutate( 
 # 
 #     Significance = case_when( 
 # 
 #       `Pr(>F)` < 0.001 ~ "***", 
 # 
 #       `Pr(>F)` < 0.01 ~ "**", 
 # 
 #       `Pr(>F)` < 0.05 ~ "*", 
 # 
 #       `Pr(>F)` < 0.1 ~ "·", 
 # 
 #       TRUE ~ ""  # No asterisk for p > 0.05 
 # 
 #     ), 
 # 
 #     Predictor_with_significance = paste(Predictor, Significance, sep = " ") 
 # 
 #   ) %>% 
 # 
 #   select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns 
 # 
 #   rename(Predictor = Predictor_with_significance) %>%  # Renames column 
 # 
 #   mutate( 
 # 
 #     # Round all numeric columns to 3 decimal points 
 # 
 #     across(where(is.numeric), ~ round(., 3)), 
 # 
 #     # Add the new column 'Response' with "Diversity" in all rows 
 # 
 #     Response = "PL periodo_fruto" 
 # 
 #   ) %>% 
 # 
 #   select(Response, Predictor, everything()) %>%  # Moves Response to the first column 
 # 
 #   kable("html", caption = "ANOVA Results for PLperiodo_fruto Model") %>% 
 # 
 #   kable_styling( 
 # 
 #     bootstrap_options = c("striped", "hover", "condensed"),  
 # 
 #     full_width = FALSE 
 # 
 #   ) %>% 
 # 
 #   column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response 
 # 
 #   column_spec(2, width = "10em")  # Adjust width of Predictor column 
 # 

```

```{r PLOTTING PL periodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 plot_PL_variable(PLdata, periodo_fruto)
```
 

### P.lagopus - ESPERANZA DE VIDA

```{r PLdias_muerte Model, include=FALSE}
#filtramos las filas con datos de nº de dias_muertees
PLdata.dias_muerte <- subset(PLdata, !is.na(dias_muerte))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLdias_muertemodel <- lm(sqrt(dias_muerte) ~ trat + clip + trat:clip, data = PLdata.dias_muerte, na.action = na.fail)

sample_size <- nrow(PLdata.dias_muerte)
# Extract the formula from the model
model_formula <- formula(PLdias_muertemodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLdias_muerte: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLdias_muertemodel)
plot(residuals)
```

```{r SUMMARY OF PLdias_muerte MODEL, include=FALSE}
summary <- summary(PLdias_muertemodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLdias_muerte MODEL, include=FALSE}
anova_dias_muerte <- Anova(PLdias_muertemodel, type = 2, test.statistic = "F")
anova_dias_muerte
```

```{r PLdias_muerte Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLdias_muertemodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLdias_muertemodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLdias_muerte Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLdias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLdias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_muerte %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL dias_muerte"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLdias_muerte Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL dias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, dias_muerte)

```

### P.lagopus - FENOLES

```{r PLfenoles Model, include=FALSE}
#filtramos las filas con datos de nº de fenoleses
PLdata.fenoles <- subset(PLdata, !is.na(fenoles))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
PLfenolesmodel <- lm(sqrt(fenoles) ~ trat + clip + trat:clip, data = PLdata.fenoles, na.action = na.fail)

sample_size <- nrow(PLdata.fenoles)
# Extract the formula from the model
model_formula <- formula(PLfenolesmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA PLfenoles: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = PLfenolesmodel)
plot(residuals)
```

```{r SUMMARY OF PLfenoles MODEL, include=FALSE}
summary <- summary(PLfenolesmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF PLfenoles MODEL, include=FALSE}
anova_fenoles <- Anova(PLfenolesmodel, type = 2, test.statistic = "F")
anova_fenoles
```

```{r PLfenoles Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(PLfenolesmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(PLfenolesmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [PLfenoles Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc PLfenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA PLfenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_fenoles %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "PL fenoles"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for PLfenoles Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING PL fenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_PL_variable(PLdata, fenoles)
```
