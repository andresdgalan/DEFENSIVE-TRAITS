---
title: "DEFENSIVE TRAITS C.arvensis SIBECOL 2025"
author: "Andrés Delgado Galán"
date: "2025-05-18"
output:
  html_document: default
  pdf_document: default
---

```{r LOADING DATA AND PACKAGES, include=FALSE}

library(dplyr)
library(DHARMa)
library(ggplot2)
library(ggeffects)
library(cowplot)
library(kableExtra)
library(tibble)
library(knitr)
library(emmeans)
library(car)
library(scales)

data <- read.table("rawdata/datos_sibecol_2025.csv", header = TRUE, sep = ";")
datamother <- read.table("rawdata/seedmother.csv", header = TRUE, sep = ";")
```

```{r PRE-ANALYSIS Data PREPARATION, include=FALSE}
#hacemos una matriz para para la especie CA
CAdata <- data |> filter(sp == "CA")
```

```{r PREPARING A PLOTTING FUNCTION, include=FALSE}
# Define color palettes
custom_colors <- c("Grazed" = "#FF10F0", "Ungrazed" = "#006400")
lighter_colors <- c("Grazed" = alpha("#FF10F0", 0.3), "Ungrazed" = alpha("#006400", 0.3))

# Named vectors for relabeling
trat_labels <- c("gra" = "Grazed", "ex" = "Ungrazed")
clip_labels <- c("yes" = "Damaged", "no" = "Undamaged")

# Prepare your data once
CAdata <- CAdata %>%
  mutate(
    trat_label = factor(trat_labels[as.character(trat)], levels = c("Ungrazed", "Grazed")),
    clip_label = factor(clip_labels[as.character(clip)], levels = c("Undamaged", "Damaged"))
  )

# Define a reusable plotting function
plot_CA_variable <- function(data, response_var) {
  ggplot(data, aes(x = trat_label, y = {{ response_var }})) +
    
    # Boxplot
    geom_boxplot(
      aes(color = trat_label),
      fill = NA,
      size = 1,
      width = 0.5
    ) +
    
    # Violin for Undamaged (filled)
    geom_violin(
      data = filter(data, clip_label == "Undamaged"),
      aes(
        fill = trat_label,
        group = interaction(trat_label, clip_label),
        linetype = clip_label
      ),
      color = NA,
      alpha = 0.2,
      width = 0.5,
      scale = "area"
    ) +
    
    # Violin for Damaged (outline)
    geom_violin(
      data = filter(data, clip_label == "Damaged"),
      aes(
        color = trat_label,
        group = interaction(trat_label, clip_label),
        linetype = clip_label
      ),
      fill = NA,
      alpha = 0.2,
      size = 0.8,
      width = 0.5,
      scale = "area"
    ) +
    
    scale_color_manual(values = custom_colors, guide = "none") +
    scale_fill_manual(values = custom_colors, guide = "none") +
    scale_linetype_manual(
      values = c("Undamaged" = "solid", "Damaged" = "dashed"),
      name = NULL
    ) +
    
    labs(
      x = "Maternal Environment",
      y = as_label(enquo(response_var)),
      linetype = "Herbivory Simulation"
    ) +
    theme_minimal() +
    theme(
      legend.title = element_blank(),
      legend.position = "right"
    )
}

```


### C.arvensis - PRODUCCIÓN DE FLORES

```{r CAflor Model, include=FALSE}
#filtramos las filas con datos de nº de flores
CAdata.flor <- subset(CAdata, !is.na(flor))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAflormodel <- lm(sqrt(flor) ~ trat + clip + trat:clip, data = CAdata.flor, na.action = na.fail)

sample_size <- nrow(CAdata.flor)
# Extract the formula from the model
model_formula <- formula(CAflormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAflor: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAflormodel)
plot(residuals)
```

```{r SUMMARY OF CAflor MODEL, include=FALSE}
summary <- summary(CAflormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAflor MODEL, include=FALSE}
anova_flor <- Anova(CAflormodel, type = 2, test.statistic = "F")
anova_flor
```

```{r CAflor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAflormodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAflormodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAflor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAflor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAflor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_flor %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA flor"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAflor Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, flor)

```

### C.arvensis - PRODUCCIÓN DE FRUTOS

```{r CAfruto Model, include=FALSE}
#filtramos las filas con datos de nº de frutoes
CAdata.fruto <- subset(CAdata, !is.na(fruto))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAfrutomodel <- lm(sqrt(fruto) ~ trat + clip + trat:clip, data = CAdata.fruto, na.action = na.fail)

sample_size <- nrow(CAdata.fruto)
# Extract the formula from the model
model_formula <- formula(CAfrutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAfruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAfrutomodel)
plot(residuals)
```

```{r SUMMARY OF CAfruto MODEL, include=FALSE}
summary <- summary(CAfrutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAfruto MODEL, include=FALSE}
anova_fruto <- Anova(CAfrutomodel, type = 2, test.statistic = "F")
anova_fruto
```

```{r CAfruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAfrutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAfrutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAfruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_fruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA fruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAfruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, fruto)

```

### C.arvensis - PRODUCCIÓN DE HOJAS

```{r CAhojas Model, include=FALSE}
#filtramos las filas con datos de nº de hojases
CAdata.hojas <- subset(CAdata, !is.na(hojas))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAhojasmodel <- lm(log(hojas) ~ trat + clip + trat:clip, data = CAdata.hojas, na.action = na.fail)

sample_size <- nrow(CAdata.hojas)
# Extract the formula from the model
model_formula <- formula(CAhojasmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAhojas: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAhojasmodel)
plot(residuals)
```

```{r SUMMARY OF CAhojas MODEL, include=FALSE}
summary <- summary(CAhojasmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAhojas MODEL, include=FALSE}
anova_hojas <- Anova(CAhojasmodel, type = 2, test.statistic = "F")
anova_hojas
```

```{r CAhojas Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAhojasmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAhojasmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAhojas Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAhojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAhojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_hojas %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA hojas"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAhojas Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA hojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, hojas)
```

### C.arvensis - ALTURA MÁXIMA

```{r CAaltura Model, include=FALSE}
#filtramos las filas con datos de nº de alturaes
CAdata.altura <- subset(CAdata, !is.na(altura))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAalturamodel <- lm(sqrt(altura) ~ trat + clip + trat:clip, data = CAdata.altura, na.action = na.fail)

sample_size <- nrow(CAdata.altura)
# Extract the formula from the model
model_formula <- formula(CAalturamodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAaltura: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAalturamodel)
plot(residuals)
```

```{r SUMMARY OF CAaltura MODEL, include=FALSE}
summary <- summary(CAalturamodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAaltura MODEL, include=FALSE}
anova_altura <- Anova(CAalturamodel, type = 2, test.statistic = "F")
anova_altura
```

```{r CAaltura Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAalturamodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAalturamodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAaltura Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAaltura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAaltura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_altura %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA altura"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAaltura Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA altura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, altura)


```

### C.arvensis - SEMILLAS/FRUTO

```{r CAseedfruto Model, include=FALSE}
#filtramos las filas con datos de nº de seedfrutoes
CAdata.seedfruto <- subset(CAdata, !is.na(seedfruto))
CAdata.seedfruto$seedfruto

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAseedfrutomodel <- lm(sqrt(seedfruto) ~ trat + clip + trat:clip, data = CAdata.seedfruto, na.action = na.fail)

sample_size <- nrow(CAdata.seedfruto)
# Extract the formula from the model
model_formula <- formula(CAseedfrutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAseedfruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAseedfrutomodel)
plot(residuals)
```

```{r SUMMARY OF CAseedfruto MODEL, include=FALSE}
summary <- summary(CAseedfrutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAseedfruto MODEL, include=FALSE}
anova_seedfruto <- Anova(CAseedfrutomodel, type = 2, test.statistic = "F")
anova_seedfruto
```

```{r CAseedfruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAseedfrutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAseedfrutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAseedfruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAseedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAseedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_seedfruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA seedfruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAseedfruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA seedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, seedfruto)

```

### C.arvensis - PRODUCCIÓN DE SEMILLAS

```{r CAseedtotal Model, include=FALSE}
#filtramos las filas con datos de nº de seedtotales
CAdata.seedtotal <- subset(CAdata, !is.na(seedtotal))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAseedtotalmodel <- lm(sqrt(seedtotal) ~ trat + clip + trat:clip, data = CAdata.seedtotal, na.action = na.fail)

sample_size <- nrow(CAdata.seedtotal)
# Extract the formula from the model
model_formula <- formula(CAseedtotalmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAseedtotal: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAseedtotalmodel)
plot(residuals)
```

```{r SUMMARY OF CAseedtotal MODEL, include=FALSE}
summary <- summary(CAseedtotalmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAseedtotal MODEL, include=FALSE}
anova_seedtotal <- Anova(CAseedtotalmodel, type = 2, test.statistic = "F")
anova_seedtotal
```

```{r CAseedtotal Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAseedtotalmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAseedtotalmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAseedtotal Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAseedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAseedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_seedtotal %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA seedtotal"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAseedtotal Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA seedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, seedtotal)

```

### C.arvensis - PESO MEDIO DE LAS SEMILLAS

```{r CAmassseed Model, include=FALSE}
#filtramos las filas con datos de nº de massseedes
CAdata.massseed <- subset(CAdata, !is.na(massseed))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAmassseedmodel <- lm(sqrt(massseed) ~ trat + clip + trat:clip, data = CAdata.massseed, na.action = na.fail)

sample_size <- nrow(CAdata.massseed)
# Extract the formula from the model
model_formula <- formula(CAmassseedmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAmassseed: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAmassseedmodel)
plot(residuals)
```

```{r SUMMARY OF CAmassseed MODEL, include=FALSE}
summary <- summary(CAmassseedmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAmassseed MODEL, include=FALSE}
anova_massseed <- Anova(CAmassseedmodel, type = 2, test.statistic = "F")
anova_massseed
```

```{r CAmassseed Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAmassseedmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAmassseedmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAmassseed Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAmassseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAmassseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_massseed %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA massseed"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAmassseed Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA massseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, massseed)
```

### C.arvensis - SLA

```{r CASLA Model, include=FALSE}
#filtramos las filas con datos de nº de SLAes
CAdata.SLA <- subset(CAdata, !is.na(SLA))
# # Find the row with the highest SLA value (OUTLIER)
# out <- CAdata.SLA[which(CAdata.SLA$SLA > 600), ]
# out$id
# 
# #REMOVING EXTRECA VALUES OF SLA
# CAdata.SLA <- CAdata.SLA[!CAdata.SLA$id %in% c(97,102), ]


#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CASLAmodel <- lm(sqrt(SLA) ~ trat + clip + trat:clip, data = CAdata.SLA, na.action = na.fail)

sample_size <- nrow(CAdata.SLA)
# Extract the formula from the model
model_formula <- formula(CASLAmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`** 

```{r DHARMA CASLA: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CASLAmodel)
plot(residuals)
```

```{r SUMMARY OF CASLA MODEL, include=FALSE}
summary <- summary(CASLAmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CASLA MODEL, include=FALSE}
anova_SLA <- Anova(CASLAmodel, type = 2, test.statistic = "F")
anova_SLA
```

```{r CASLA Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CASLAmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CASLAmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CASLA Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CASLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CASLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_SLA %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA SLA"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CASLA Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA SLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata.SLA, SLA)

```

### C.arvensis - LDMC

```{r CALDMC Model, include=FALSE}
#filtramos las filas con datos de nº de LDMCes
CAdata.LDMC <- subset(CAdata, !is.na(LDMC))



#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CALDMCmodel <- lm(sqrt(LDMC) ~ trat + clip + trat:clip, data = CAdata.LDMC, na.action = na.fail)

sample_size <- nrow(CAdata.LDMC)
# Extract the formula from the model
model_formula <- formula(CALDMCmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CALDMC: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CALDMCmodel)
plot(residuals)
```

```{r SUMMARY OF CALDMC MODEL, include=FALSE}
summary <- summary(CALDMCmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CALDMC MODEL, include=FALSE}
anova_LDMC <- Anova(CALDMCmodel, type = 2, test.statistic = "F")
anova_LDMC
```

```{r CALDMC Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CALDMCmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CALDMCmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CALDMC Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CALDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CALDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_LDMC %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA LDMC"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CALDMC Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA LDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, LDMC)
```

### C.arvensis - ÁREA FOLIAR

```{r CAarea.m Model, include=FALSE}
#filtramos las filas con datos de nº de area.mes
CAdata.area.m <- subset(CAdata, !is.na(area.m))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAarea.mmodel <- lm(sqrt(area.m) ~ trat + clip + trat:clip, data = CAdata.area.m, na.action = na.fail)

sample_size <- nrow(CAdata.area.m)
# Extract the formula from the model
model_formula <- formula(CAarea.mmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAarea.m: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAarea.mmodel)
plot(residuals)
```

```{r SUMMARY OF CAarea.m MODEL, include=FALSE}
summary <- summary(CAarea.mmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAarea.m MODEL, include=FALSE}
anova_area.m <- Anova(CAarea.mmodel, type = 2, test.statistic = "F")
anova_area.m
```

```{r CAarea.m Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAarea.mmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAarea.mmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAarea.m Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAarea.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAarea.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_area.m %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA area.m"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAarea.m Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA area.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, area.m)
```


### C.arvensis - FENOLOGÍA DE FLORACIÓN

```{r CAdias_flor Model, include=FALSE}
#filtramos las filas con datos de nº de dias_flores
CAdata.dias_flor <- subset(CAdata, !is.na(dias_flor))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAdias_flormodel <- lm(sqrt(dias_flor) ~ trat + clip + trat:clip, data = CAdata.dias_flor, na.action = na.fail)

sample_size <- nrow(CAdata.dias_flor)
sample_size
# Extract the formula from the model
model_formula <- formula(CAdias_flormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAdias_flor: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAdias_flormodel)
plot(residuals)
```

```{r SUMMARY OF CAdias_flor MODEL, include=FALSE}
summary <- summary(CAdias_flormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAdias_flor MODEL, include=FALSE}
anova_dias_flor <- Anova(CAdias_flormodel, type = 2, test.statistic = "F")
anova_dias_flor
```

```{r CAdias_flor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAdias_flormodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAdias_flormodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAdias_flor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAdias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAdias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_flor %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA dias_flor"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAdias_flor Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA dias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, dias_flor)

```

### C.arvensis - FENOLOGÍA DE FRUCTIFICACÓN

```{r CAdias_fruto Model, include=FALSE}
#filtramos las filas con datos de nº de dias_frutoes
CAdata.dias_fruto <- subset(CAdata, !is.na(dias_fruto))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAdias_frutomodel <- lm(sqrt(dias_fruto) ~ trat + clip + trat:clip, data = CAdata.dias_fruto, na.action = na.fail)

sample_size <- nrow(CAdata.dias_fruto)
sample_size
# Extract the formula from the model
model_formula <- formula(CAdias_frutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAdias_fruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAdias_frutomodel)
plot(residuals)
```

```{r SUMMARY OF CAdias_fruto MODEL, include=FALSE}
summary <- summary(CAdias_frutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAdias_fruto MODEL, include=FALSE}
anova_dias_fruto <- Anova(CAdias_frutomodel, type = 2, test.statistic = "F")
anova_dias_fruto
```

```{r CAdias_fruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAdias_frutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAdias_frutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAdias_fruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAdias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAdias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_fruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA dias_fruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAdias_fruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA dias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, dias_fruto)


```

### C.arvensis - PERIODO DE FLORACIÓN

```{r CAperiodo_flor Model, include=FALSE}
#Creamos la variable periodo_flor
CAdata$periodo_flor <- CAdata$dias_fin_flor - CAdata$dias_flor
#filtramos las filas con datos de nº de periodo_flores
CAdata.periodo_flor <- subset(CAdata, !is.na(periodo_flor))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAperiodo_flormodel <- lm(sqrt(periodo_flor) ~ trat + clip + trat:clip, data = CAdata.periodo_flor, na.action = na.fail)#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAperiodo_flormodel <- lm(sqrt(periodo_flor) ~ trat + clip + trat:clip, data = CAdata.periodo_flor, na.action = na.fail)

sample_size <- nrow(CAdata.periodo_flor)
sample_size
# Extract the formula from the model
model_formula <- formula(CAperiodo_flormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAperiodo_flor: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAperiodo_flormodel)
plot(residuals)
```

```{r SUMMARY OF CAperiodo_flor MODEL, include=FALSE}
summary <- summary(CAperiodo_flormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAperiodo_flor MODEL, include=FALSE}
anova_periodo_flor <- Anova(CAperiodo_flormodel, type = 2, test.statistic = "F")
anova_periodo_flor
```

```{r CAperiodo_flor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAperiodo_flormodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAperiodo_flormodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAperiodo_flor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAperiodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAperiodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_periodo_flor %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA periodo_flor"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAperiodo_flor Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA periodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, periodo_flor)

```

### C.arvensis - PERIODO DE FRUCTIFICACIÓN

```{r CAperiodo_fruto Model, include=FALSE} 
#Creamos la variable periodo_fruto
CAdata$periodo_fruto <- CAdata$dias_fin_fruto - CAdata$dias_fruto
 #filtramos las filas con datos de nº de periodo_frutoes 

 CAdata.periodo_fruto <- subset(CAdata, !is.na(periodo_fruto)) 

 #probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos 

 CAperiodo_frutomodel <- lm(sqrt(periodo_fruto) ~ trat + clip + trat:clip, data = CAdata.periodo_fruto, na.action = na.fail) 

 sample_size <- nrow(CAdata.periodo_fruto) 

 # Extract the formula from the model 

 model_formula <- formula(CAperiodo_frutomodel) 

 # Convert formula to character and clean up 

 model_formula_clean <- deparse(model_formula) 

```


 **`r model_formula_clean`**\ 

 n = **`r sample_size`** 


```{r DHARMA CAperiodo_fruto: checking residuals, echo=FALSE, fig.show='hide'} 

 residuals <- simulateResiduals(fittedModel = CAperiodo_frutomodel) 

 plot(residuals) 

```

```{r SUMMARY OF CAperiodo_fruto MODEL, include=FALSE} 

 summary <- summary(CAperiodo_frutomodel) 

 rsq <- summary$adj.r.squared 

 rsq 

```

 R² = **`r rsq`** 

```{r ANOVA OF CAperiodo_fruto MODEL, include=FALSE} 

 anova_periodo_fruto <- Anova(CAperiodo_frutomodel, type = 2, test.statistic = "F") 

 anova_periodo_fruto 

```

```{r CAperiodo_fruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE} 

 # This will compare treatment levels within each level of grazer 

 posthoc_trat <- emmeans(CAperiodo_frutomodel, pairwise ~ trat | clip, adjust = "tukey") 

 print(posthoc_trat) 

 # This will compare grazer levels within each treatment 

 posthoc_clip <- emmeans(CAperiodo_frutomodel, pairwise ~ clip | trat, adjust = "tukey") 

 print(posthoc_clip) 

 # Visualizing results 

 # Plot treatment differences within each grazer 

 plot(posthoc_trat$emmeans)   

 # Plot grazer differences within each treatment 

 plot(posthoc_clip$emmeans) 


```


 ##### [CAperiodo_fruto Post-hoc Comparisons with Tukeys HSD]{.underline} 

```{r Post-hoc CAperiodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 kable(as.data.frame(posthoc_clip$contrasts)) 

 kable(as.data.frame(posthoc_trat$contrasts)) 


```

```{r ANOVA CAperiodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 # Convert the ANOVA results to a data frame and create a styled table 

 anova_periodo_fruto %>% 

   as.data.frame() %>% 

   rownames_to_column("Predictor") %>% 

   mutate( 

     Significance = case_when( 

       `Pr(>F)` < 0.001 ~ "***", 

       `Pr(>F)` < 0.01 ~ "**", 

       `Pr(>F)` < 0.05 ~ "*", 

       `Pr(>F)` < 0.1 ~ "·", 

       TRUE ~ ""  # No asterisk for p > 0.05 

     ), 

     Predictor_with_significance = paste(Predictor, Significance, sep = " ") 

   ) %>% 

   select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns 

   rename(Predictor = Predictor_with_significance) %>%  # Renames column 

   mutate( 

     # Round all numeric columns to 3 decimal points 

     across(where(is.numeric), ~ round(., 3)), 

     # Add the new column 'Response' with "Diversity" in all rows 

     Response = "CA periodo_fruto" 

   ) %>% 

   select(Response, Predictor, everything()) %>%  # Moves Response to the first column 

   kable("html", caption = "ANOVA Results for CAperiodo_fruto Model") %>% 

   kable_styling( 

     bootstrap_options = c("striped", "hover", "condensed"),  

     full_width = FALSE 

   ) %>% 

   column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response 

   column_spec(2, width = "10em")  # Adjust width of Predictor column 


```

```{r PLOTTING CA periodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 plot_CA_variable(CAdata, periodo_fruto)
```
 

### C.arvensis - ESPERANZA DE VIDA

```{r CAdias_muerte Model, include=FALSE}
#filtramos las filas con datos de nº de dias_muertees
CAdata.dias_muerte <- subset(CAdata, !is.na(dias_muerte))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAdias_muertemodel <- lm(sqrt(dias_muerte) ~ trat + clip + trat:clip, data = CAdata.dias_muerte, na.action = na.fail)

sample_size <- nrow(CAdata.dias_muerte)
# Extract the formula from the model
model_formula <- formula(CAdias_muertemodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAdias_muerte: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAdias_muertemodel)
plot(residuals)
```

```{r SUMMARY OF CAdias_muerte MODEL, include=FALSE}
summary <- summary(CAdias_muertemodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAdias_muerte MODEL, include=FALSE}
anova_dias_muerte <- Anova(CAdias_muertemodel, type = 2, test.statistic = "F")
anova_dias_muerte
```

```{r CAdias_muerte Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAdias_muertemodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAdias_muertemodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAdias_muerte Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAdias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAdias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_muerte %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA dias_muerte"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAdias_muerte Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA dias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, dias_muerte)

```

### C.arvensis - FENOLES

```{r CAfenoles Model, include=FALSE}
#filtramos las filas con datos de nº de fenoleses
CAdata.fenoles <- subset(CAdata, !is.na(fenoles))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
CAfenolesmodel <- lm(sqrt(fenoles) ~ trat + clip + trat:clip, data = CAdata.fenoles, na.action = na.fail)

sample_size <- nrow(CAdata.fenoles)
# Extract the formula from the model
model_formula <- formula(CAfenolesmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA CAfenoles: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = CAfenolesmodel)
plot(residuals)
```

```{r SUMMARY OF CAfenoles MODEL, include=FALSE}
summary <- summary(CAfenolesmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF CAfenoles MODEL, include=FALSE}
anova_fenoles <- Anova(CAfenolesmodel, type = 2, test.statistic = "F")
anova_fenoles
```

```{r CAfenoles Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(CAfenolesmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(CAfenolesmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [CAfenoles Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc CAfenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA CAfenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_fenoles %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "CA fenoles"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for CAfenoles Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING CA fenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_CA_variable(CAdata, fenoles)
```
