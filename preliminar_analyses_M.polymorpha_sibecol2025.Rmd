---
title: "DEFENSIVE TRAITS M.polymorpha SIBECOL 2025"
author: "Andrés Delgado Galán"
date: "2025-05-18"
output:
  html_document: default
  pdf_document: default
---

```{r LOADING DATA AND PACKAGES, include=FALSE}

library(dplyr)
library(DHARMa)
library(ggplot2)
library(ggeffects)
library(cowplot)
library(kableExtra)
library(tibble)
library(knitr)
library(emmeans)
library(car)
library(scales)

data <- read.table("rawdata/datos_sibecol_2025.csv", header = TRUE, sep = ";")
datamother <- read.table("rawdata/seedmother.csv", header = TRUE, sep = ";")
```

```{r PRE-ANALYSIS Data PREPARATION, include=FALSE}
#hacemos una matriz para para la especie ME
MEdata <- data |> filter(sp == "ME")
```

```{r PREPARING A PLOTTING FUNCTION, include=FALSE}
# Define color palettes
custom_colors <- c("Grazed" = "#FF10F0", "Ungrazed" = "#006400")
lighter_colors <- c("Grazed" = alpha("#FF10F0", 0.3), "Ungrazed" = alpha("#006400", 0.3))

# Named vectors for relabeling
trat_labels <- c("gra" = "Grazed", "ex" = "Ungrazed")
clip_labels <- c("yes" = "Damaged", "no" = "Undamaged")

# Prepare your data once
MEdata <- MEdata %>%
  mutate(
    trat_label = factor(trat_labels[as.character(trat)], levels = c("Ungrazed", "Grazed")),
    clip_label = factor(clip_labels[as.character(clip)], levels = c("Undamaged", "Damaged"))
  )

# Define a reusable plotting function
plot_ME_variable <- function(data, response_var) {
  ggplot(data, aes(x = trat_label, y = {{ response_var }})) +
    
    # Boxplot
    geom_boxplot(
      aes(color = trat_label),
      fill = NA,
      size = 1,
      width = 0.5
    ) +
    
    # Violin for Undamaged (filled)
    geom_violin(
      data = filter(data, clip_label == "Undamaged"),
      aes(
        fill = trat_label,
        group = interaction(trat_label, clip_label),
        linetype = clip_label
      ),
      color = NA,
      alpha = 0.2,
      width = 0.5,
      scale = "area"
    ) +
    
    # Violin for Damaged (outline)
    geom_violin(
      data = filter(data, clip_label == "Damaged"),
      aes(
        color = trat_label,
        group = interaction(trat_label, clip_label),
        linetype = clip_label
      ),
      fill = NA,
      alpha = 0.2,
      size = 0.8,
      width = 0.5,
      scale = "area"
    ) +
    
    scale_color_manual(values = custom_colors, guide = "none") +
    scale_fill_manual(values = custom_colors, guide = "none") +
    scale_linetype_manual(
      values = c("Undamaged" = "solid", "Damaged" = "dashed"),
      name = NULL
    ) +
    
    labs(
      x = "Maternal Environment",
      y = as_label(enquo(response_var)),
      linetype = "Herbivory Simulation"
    ) +
    theme_minimal() +
    theme(
      legend.title = element_blank(),
      legend.position = "right"
    )
}

```


### M.polymorpha - PRODUCCIÓN DE FLORES

```{r MEflor Model, include=FALSE}
#filtramos las filas con datos de nº de flores
MEdata.flor <- subset(MEdata, !is.na(flor))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEflormodel <- lm(sqrt(flor) ~ trat + clip + trat:clip, data = MEdata.flor, na.action = na.fail)

sample_size <- nrow(MEdata.flor)
# Extract the formula from the model
model_formula <- formula(MEflormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEflor: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEflormodel)
plot(residuals)
```

```{r SUMMARY OF MEflor MODEL, include=FALSE}
summary <- summary(MEflormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEflor MODEL, include=FALSE}
anova_flor <- Anova(MEflormodel, type = 2, test.statistic = "F")
anova_flor
```

```{r MEflor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEflormodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEflormodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEflor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEflor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEflor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_flor %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME flor"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEflor Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, flor)

```

### M.polymorpha - PRODUCCIÓN DE FRUTOS

```{r MEfruto Model, include=FALSE}
#filtramos las filas con datos de nº de frutoes
MEdata.fruto <- subset(MEdata, !is.na(fruto))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEfrutomodel <- lm(sqrt(fruto) ~ trat + clip + trat:clip, data = MEdata.fruto, na.action = na.fail)

sample_size <- nrow(MEdata.fruto)
# Extract the formula from the model
model_formula <- formula(MEfrutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEfruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEfrutomodel)
plot(residuals)
```

```{r SUMMARY OF MEfruto MODEL, include=FALSE}
summary <- summary(MEfrutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEfruto MODEL, include=FALSE}
anova_fruto <- Anova(MEfrutomodel, type = 2, test.statistic = "F")
anova_fruto
```

```{r MEfruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEfrutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEfrutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEfruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_fruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME fruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEfruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, fruto)

```

### M.polymorpha - PRODUCCIÓN DE MEJAS

```{r MEhojas Model, include=FALSE}
#filtramos las filas con datos de nº de hojases
MEdata.hojas <- subset(MEdata, !is.na(hojas))
plot(density(MEdata.hojas$hojas))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEhojasmodel <- lm(sqrt(hojas) ~ trat + clip + trat:clip, data = MEdata.hojas, na.action = na.fail)

sample_size <- nrow(MEdata.hojas)
# Extract the formula from the model
model_formula <- formula(MEhojasmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEhojas: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEhojasmodel)
plot(residuals)
```

```{r SUMMARY OF MEhojas MODEL, include=FALSE}
summary <- summary(MEhojasmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEhojas MODEL, include=FALSE}
anova_hojas <- Anova(MEhojasmodel, type = 2, test.statistic = "F")
anova_hojas
```

```{r MEhojas Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEhojasmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEhojasmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEhojas Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEhojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEhojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_hojas %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME hojas"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEhojas Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME hojas, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, hojas)
```

### M.polymorpha - ALTURA MÁXIMA

```{r MEaltura Model, include=FALSE}
#filtramos las filas con datos de nº de alturaes
MEdata.altura <- subset(MEdata, !is.na(altura))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEalturamodel <- lm(sqrt(altura) ~ trat + clip + trat:clip, data = MEdata.altura, na.action = na.fail)

sample_size <- nrow(MEdata.altura)
# Extract the formula from the model
model_formula <- formula(MEalturamodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEaltura: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEalturamodel)
plot(residuals)
```

```{r SUMMARY OF MEaltura MODEL, include=FALSE}
summary <- summary(MEalturamodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEaltura MODEL, include=FALSE}
anova_altura <- Anova(MEalturamodel, type = 2, test.statistic = "F")
anova_altura
```

```{r MEaltura Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEalturamodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEalturamodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEaltura Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEaltura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEaltura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_altura %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME altura"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEaltura Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME altura, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, altura)


```

### M.polymorpha - SEMILLAS/FRUTO

```{r MEseedfruto Model, include=FALSE}
#filtramos las filas con datos de nº de seedfrutoes
MEdata.seedfruto <- subset(MEdata, !is.na(seedfruto))
MEdata.seedfruto$seedfruto

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEseedfrutomodel <- lm(sqrt(seedfruto) ~ trat + clip + trat:clip, data = MEdata.seedfruto, na.action = na.fail)

sample_size <- nrow(MEdata.seedfruto)
# Extract the formula from the model
model_formula <- formula(MEseedfrutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEseedfruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEseedfrutomodel)
plot(residuals)
```

```{r SUMMARY OF MEseedfruto MODEL, include=FALSE}
summary <- summary(MEseedfrutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEseedfruto MODEL, include=FALSE}
anova_seedfruto <- Anova(MEseedfrutomodel, type = 2, test.statistic = "F")
anova_seedfruto
```

```{r MEseedfruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEseedfrutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEseedfrutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEseedfruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEseedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEseedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_seedfruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME seedfruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEseedfruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME seedfruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, seedfruto)

```

### M.polymorpha - PRODUCCIÓN DE SEMILLAS

```{r MEseedtotal Model, include=FALSE}
#filtramos las filas con datos de nº de seedtotales
MEdata.seedtotal <- subset(MEdata, !is.na(seedtotal))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEseedtotalmodel <- lm(sqrt(seedtotal) ~ trat + clip + trat:clip, data = MEdata.seedtotal, na.action = na.fail)

sample_size <- nrow(MEdata.seedtotal)
# Extract the formula from the model
model_formula <- formula(MEseedtotalmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEseedtotal: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEseedtotalmodel)
plot(residuals)
```

```{r SUMMARY OF MEseedtotal MODEL, include=FALSE}
summary <- summary(MEseedtotalmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEseedtotal MODEL, include=FALSE}
anova_seedtotal <- Anova(MEseedtotalmodel, type = 2, test.statistic = "F")
anova_seedtotal
```

```{r MEseedtotal Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEseedtotalmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEseedtotalmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEseedtotal Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEseedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEseedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_seedtotal %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME seedtotal"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEseedtotal Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME seedtotal, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, seedtotal)

```

### M.polymorpha - PESO MEDIO DE LAS SEMILLAS

```{r MEmassseed Model, include=FALSE}
#filtramos las filas con datos de nº de massseedes
MEdata.massseed <- subset(MEdata, !is.na(massseed))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEmassseedmodel <- lm(sqrt(massseed) ~ trat + clip + trat:clip, data = MEdata.massseed, na.action = na.fail)

sample_size <- nrow(MEdata.massseed)
# Extract the formula from the model
model_formula <- formula(MEmassseedmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEmassseed: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEmassseedmodel)
plot(residuals)
```

```{r SUMMARY OF MEmassseed MODEL, include=FALSE}
summary <- summary(MEmassseedmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEmassseed MODEL, include=FALSE}
anova_massseed <- Anova(MEmassseedmodel, type = 2, test.statistic = "F")
anova_massseed
```

```{r MEmassseed Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEmassseedmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEmassseedmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEmassseed Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEmassseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEmassseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_massseed %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME massseed"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEmassseed Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME massseed, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, massseed)
```

### M.polymorpha - SLA

```{r MESLA Model, include=FALSE}
#filtramos las filas con datos de nº de SLAes
MEdata.SLA <- subset(MEdata, !is.na(SLA))
plot(density(MEdata.SLA$SLA))
# Find the row with the highest SLA value (OUTLIER)
out <- MEdata.SLA[which(MEdata.SLA$SLA > 700), ]
out$id

#REMOVING EXTREME VALUES OF SLA
MEdata.SLA <- MEdata.SLA[!MEdata.SLA$id %in% c(373,376,379,401), ]

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MESLAmodel <- lm(log(SLA) ~ trat + clip + trat:clip, data = MEdata.SLA, na.action = na.fail)

sample_size <- nrow(MEdata.SLA)
# Extract the formula from the model
model_formula <- formula(MESLAmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MESLA: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MESLAmodel)
plot(residuals)
```

```{r SUMMARY OF MESLA MODEL, include=FALSE}
summary <- summary(MESLAmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MESLA MODEL, include=FALSE}
anova_SLA <- Anova(MESLAmodel, type = 2, test.statistic = "F")
anova_SLA
```

```{r MESLA Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MESLAmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MESLAmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MESLA Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MESLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MESLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_SLA %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME SLA"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MESLA Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME SLA, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata.SLA, SLA)

```

### M.polymorpha - LDMC

```{r MELDMC Model, include=FALSE}
#filtramos las filas con datos de nº de LDMCes
MEdata.LDMC <- subset(MEdata, !is.na(LDMC))



#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MELDMCmodel <- lm(sqrt(LDMC) ~ trat + clip + trat:clip, data = MEdata.LDMC, na.action = na.fail)

sample_size <- nrow(MEdata.LDMC)
# Extract the formula from the model
model_formula <- formula(MELDMCmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MELDMC: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MELDMCmodel)
plot(residuals)
```

```{r SUMMARY OF MELDMC MODEL, include=FALSE}
summary <- summary(MELDMCmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MELDMC MODEL, include=FALSE}
anova_LDMC <- Anova(MELDMCmodel, type = 2, test.statistic = "F")
anova_LDMC
```

```{r MELDMC Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MELDMCmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MELDMCmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MELDMC Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MELDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MELDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_LDMC %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME LDMC"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MELDMC Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME LDMC, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, LDMC)
```

### M.polymorpha - ÁREA FOLIAR

```{r MEarea.m Model, include=FALSE}
#filtramos las filas con datos de nº de area.mes
MEdata.area.m <- subset(MEdata, !is.na(area.m))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEarea.mmodel <- lm(sqrt(area.m) ~ trat + clip + trat:clip, data = MEdata.area.m, na.action = na.fail)

sample_size <- nrow(MEdata.area.m)
# Extract the formula from the model
model_formula <- formula(MEarea.mmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEarea.m: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEarea.mmodel)
plot(residuals)
```

```{r SUMMARY OF MEarea.m MODEL, include=FALSE}
summary <- summary(MEarea.mmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEarea.m MODEL, include=FALSE}
anova_area.m <- Anova(MEarea.mmodel, type = 2, test.statistic = "F")
anova_area.m
```

```{r MEarea.m Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEarea.mmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEarea.mmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEarea.m Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEarea.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEarea.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_area.m %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME area.m"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEarea.m Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME area.m, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, area.m)
```
Quité los valores extremos con el SLA y tampoco salía bien. Habría que mirar estos valores de area foliar tan altos pero aún así no parece haber ningún patrón.


### M.polymorpha - FENOLOGÍA DE FLORACIÓN

```{r MEdias_flor Model, include=FALSE}
#filtramos las filas con datos de nº de dias_flores
MEdata.dias_flor <- subset(MEdata, !is.na(dias_flor))
plot(density(MEdata.dias_flor$dias_flor))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEdias_flormodel <- lm(log(dias_flor) ~ trat + clip + trat:clip, data = MEdata.dias_flor, na.action = na.fail)

sample_size <- nrow(MEdata.dias_flor)
sample_size
# Extract the formula from the model
model_formula <- formula(MEdias_flormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEdias_flor: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEdias_flormodel)
plot(residuals)
```

```{r SUMMARY OF MEdias_flor MODEL, include=FALSE}
summary <- summary(MEdias_flormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEdias_flor MODEL, include=FALSE}
anova_dias_flor <- Anova(MEdias_flormodel, type = 2, test.statistic = "F")
anova_dias_flor
```

```{r MEdias_flor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEdias_flormodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEdias_flormodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEdias_flor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEdias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEdias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_flor %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME dias_flor"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEdias_flor Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME dias_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, dias_flor)

```

### M.polymorpha - FENOLOGÍA DE FRUCTIFICACÓN

```{r MEdias_fruto Model, include=FALSE}
#filtramos las filas con datos de nº de dias_frutoes
MEdata.dias_fruto <- subset(MEdata, !is.na(dias_fruto))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEdias_frutomodel <- lm(sqrt(dias_fruto) ~ trat + clip + trat:clip, data = MEdata.dias_fruto, na.action = na.fail)

sample_size <- nrow(MEdata.dias_fruto)
sample_size
# Extract the formula from the model
model_formula <- formula(MEdias_frutomodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEdias_fruto: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEdias_frutomodel)
plot(residuals)
```

```{r SUMMARY OF MEdias_fruto MODEL, include=FALSE}
summary <- summary(MEdias_frutomodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEdias_fruto MODEL, include=FALSE}
anova_dias_fruto <- Anova(MEdias_frutomodel, type = 2, test.statistic = "F")
anova_dias_fruto
```

```{r MEdias_fruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEdias_frutomodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEdias_frutomodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEdias_fruto Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEdias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEdias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_fruto %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME dias_fruto"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEdias_fruto Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME dias_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, dias_fruto)


```

### M.polymorpha - PERIODO DE FLORACIÓN

```{r MEperiodo_flor Model, include=FALSE}
#Creamos la variable periodo_flor
MEdata$periodo_flor <- MEdata$dias_fin_flor - MEdata$dias_flor
#filtramos las filas con datos de nº de periodo_flores
MEdata.periodo_flor <- subset(MEdata, !is.na(periodo_flor))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEperiodo_flormodel <- lm(sqrt(periodo_flor) ~ trat + clip + trat:clip, data = MEdata.periodo_flor, na.action = na.fail)#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEperiodo_flormodel <- lm(sqrt(periodo_flor) ~ trat + clip + trat:clip, data = MEdata.periodo_flor, na.action = na.fail)

sample_size <- nrow(MEdata.periodo_flor)
sample_size
# Extract the formula from the model
model_formula <- formula(MEperiodo_flormodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEperiodo_flor: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEperiodo_flormodel)
plot(residuals)
```

```{r SUMMARY OF MEperiodo_flor MODEL, include=FALSE}
summary <- summary(MEperiodo_flormodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEperiodo_flor MODEL, include=FALSE}
anova_periodo_flor <- Anova(MEperiodo_flormodel, type = 2, test.statistic = "F")
anova_periodo_flor
```

```{r MEperiodo_flor Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEperiodo_flormodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEperiodo_flormodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEperiodo_flor Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEperiodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEperiodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_periodo_flor %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME periodo_flor"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEperiodo_flor Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME periodo_flor, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, periodo_flor)

```

### M.polymorpha - PERIODO DE FRUCTIFICACIÓN

```{r MEperiodo_fruto Model, include=FALSE} 
#Creamos la variable periodo_fruto
MEdata$periodo_fruto <- MEdata$dias_fin_fruto - MEdata$dias_fruto
 #filtramos las filas con datos de nº de periodo_frutoes 

 MEdata.periodo_fruto <- subset(MEdata, !is.na(periodo_fruto)) 

 #probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos 

 MEperiodo_frutomodel <- lm(sqrt(periodo_fruto) ~ trat + clip + trat:clip, data = MEdata.periodo_fruto, na.action = na.fail) 

 sample_size <- nrow(MEdata.periodo_fruto) 

 # Extract the formula from the model 

 model_formula <- formula(MEperiodo_frutomodel) 

 # Convert formula to character and clean up 

 model_formula_clean <- deparse(model_formula) 

```


 **`r model_formula_clean`**\ 

 n = **`r sample_size`** 


```{r DHARMA MEperiodo_fruto: checking residuals, echo=FALSE, fig.show='hide'} 

 residuals <- simulateResiduals(fittedModel = MEperiodo_frutomodel) 

 plot(residuals) 

```

```{r SUMMARY OF MEperiodo_fruto MODEL, include=FALSE} 

 summary <- summary(MEperiodo_frutomodel) 

 rsq <- summary$adj.r.squared 

 rsq 

```

 R² = **`r rsq`** 

```{r ANOVA OF MEperiodo_fruto MODEL, include=FALSE} 

 anova_periodo_fruto <- Anova(MEperiodo_frutomodel, type = 2, test.statistic = "F") 

 anova_periodo_fruto 

```

```{r MEperiodo_fruto Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE} 

 # This will compare treatment levels within each level of grazer 

 posthoc_trat <- emmeans(MEperiodo_frutomodel, pairwise ~ trat | clip, adjust = "tukey") 

 print(posthoc_trat) 

 # This will compare grazer levels within each treatment 

 posthoc_clip <- emmeans(MEperiodo_frutomodel, pairwise ~ clip | trat, adjust = "tukey") 

 print(posthoc_clip) 

 # Visualizing results 

 # Plot treatment differences within each grazer 

 plot(posthoc_trat$emmeans)   

 # Plot grazer differences within each treatment 

 plot(posthoc_clip$emmeans) 


```


 ##### [MEperiodo_fruto Post-hoc Comparisons with Tukeys HSD]{.underline} 

```{r Post-hoc MEperiodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 kable(as.data.frame(posthoc_clip$contrasts)) 

 kable(as.data.frame(posthoc_trat$contrasts)) 


```

```{r ANOVA MEperiodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 # Convert the ANOVA results to a data frame and create a styled table 

 anova_periodo_fruto %>% 

   as.data.frame() %>% 

   rownames_to_column("Predictor") %>% 

   mutate( 

     Significance = case_when( 

       `Pr(>F)` < 0.001 ~ "***", 

       `Pr(>F)` < 0.01 ~ "**", 

       `Pr(>F)` < 0.05 ~ "*", 

       `Pr(>F)` < 0.1 ~ "·", 

       TRUE ~ ""  # No asterisk for p > 0.05 

     ), 

     Predictor_with_significance = paste(Predictor, Significance, sep = " ") 

   ) %>% 

   select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns 

   rename(Predictor = Predictor_with_significance) %>%  # Renames column 

   mutate( 

     # Round all numeric columns to 3 decimal points 

     across(where(is.numeric), ~ round(., 3)), 

     # Add the new column 'Response' with "Diversity" in all rows 

     Response = "ME periodo_fruto" 

   ) %>% 

   select(Response, Predictor, everything()) %>%  # Moves Response to the first column 

   kable("html", caption = "ANOVA Results for MEperiodo_fruto Model") %>% 

   kable_styling( 

     bootstrap_options = c("striped", "hover", "condensed"),  

     full_width = FALSE 

   ) %>% 

   column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response 

   column_spec(2, width = "10em")  # Adjust width of Predictor column 


```

```{r PLOTTING ME periodo_fruto, echo=FALSE, results='hold', warning=FALSE, message=FALSE} 

 plot_ME_variable(MEdata, periodo_fruto)
```
 

### M.polymorpha - ESPERANZA DE VIDA

```{r MEdias_muerte Model, include=FALSE}
#filtramos las filas con datos de nº de dias_muertees
MEdata.dias_muerte <- subset(MEdata, !is.na(dias_muerte))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEdias_muertemodel <- lm(sqrt(dias_muerte) ~ trat + clip + trat:clip, data = MEdata.dias_muerte, na.action = na.fail)

sample_size <- nrow(MEdata.dias_muerte)
# Extract the formula from the model
model_formula <- formula(MEdias_muertemodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEdias_muerte: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEdias_muertemodel)
plot(residuals)
```

```{r SUMMARY OF MEdias_muerte MODEL, include=FALSE}
summary <- summary(MEdias_muertemodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEdias_muerte MODEL, include=FALSE}
anova_dias_muerte <- Anova(MEdias_muertemodel, type = 2, test.statistic = "F")
anova_dias_muerte
```

```{r MEdias_muerte Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEdias_muertemodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEdias_muertemodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEdias_muerte Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEdias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEdias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_dias_muerte %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME dias_muerte"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEdias_muerte Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME dias_muerte, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, dias_muerte)

```

### M.polymorpha - FENOLES

```{r MEfenoles Model, include=FALSE}
#filtramos las filas con datos de nº de fenoleses
MEdata.fenoles <- subset(MEdata, !is.na(fenoles))

#probamos el modelo con distintas transformaciones y familias de glm para ver cuál es el que mejor se ajusta a los datos
MEfenolesmodel <- lm(sqrt(fenoles) ~ trat + clip + trat:clip, data = MEdata.fenoles, na.action = na.fail)

sample_size <- nrow(MEdata.fenoles)
# Extract the formula from the model
model_formula <- formula(MEfenolesmodel)
# Convert formula to character and clean up
model_formula_clean <- deparse(model_formula)
```

**`r model_formula_clean`**\
n = **`r sample_size`**

```{r DHARMA MEfenoles: checking residuals, echo=FALSE, fig.show='hide'}
residuals <- simulateResiduals(fittedModel = MEfenolesmodel)
plot(residuals)
```

```{r SUMMARY OF MEfenoles MODEL, include=FALSE}
summary <- summary(MEfenolesmodel)
rsq <- summary$adj.r.squared
rsq
```

R² = **`r rsq`**

```{r ANOVA OF MEfenoles MODEL, include=FALSE}
anova_fenoles <- Anova(MEfenolesmodel, type = 2, test.statistic = "F")
anova_fenoles
```

```{r MEfenoles Post-hoc Comparisons with Tukeys HSD, echo=FALSE, include=FALSE}
# This will compare treatment levels within each level of grazer
posthoc_trat <- emmeans(MEfenolesmodel, pairwise ~ trat | clip, adjust = "tukey")
print(posthoc_trat)

# This will compare grazer levels within each treatment
posthoc_clip <- emmeans(MEfenolesmodel, pairwise ~ clip | trat, adjust = "tukey")
print(posthoc_clip)

# Visualizing results

# Plot treatment differences within each grazer
plot(posthoc_trat$emmeans)  

# Plot grazer differences within each treatment
plot(posthoc_clip$emmeans)

```

##### [MEfenoles Post-hoc Comparisons with Tukeys HSD]{.underline}

```{r Post-hoc MEfenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
kable(as.data.frame(posthoc_clip$contrasts))

kable(as.data.frame(posthoc_trat$contrasts))

```

```{r ANOVA MEfenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
# Convert the ANOVA results to a data frame and create a styled table

anova_fenoles %>%
  as.data.frame() %>%
  rownames_to_column("Predictor") %>%
  mutate(
    Significance = case_when(
      `Pr(>F)` < 0.001 ~ "***",
      `Pr(>F)` < 0.01 ~ "**",
      `Pr(>F)` < 0.05 ~ "*",
      `Pr(>F)` < 0.1 ~ "·",
      TRUE ~ ""  # No asterisk for p > 0.05
    ),
    Predictor_with_significance = paste(Predictor, Significance, sep = " ")
  ) %>%
  select(-Predictor, -Significance) %>%  # Removes Df.res and Significance columns
  rename(Predictor = Predictor_with_significance) %>%  # Renames column
  mutate(
    # Round all numeric columns to 3 decimal points
    across(where(is.numeric), ~ round(., 3)),
    # Add the new column 'Response' with "Diversity" in all rows
    Response = "ME fenoles"
  ) %>%
  select(Response, Predictor, everything()) %>%  # Moves Response to the first column
  kable("html", caption = "ANOVA Results for MEfenoles Model") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"), 
    full_width = FALSE
  ) %>%
  column_spec(1, background = "lightgray", bold = TRUE, width = "5em") %>%  # Style Response
  column_spec(2, width = "10em")  # Adjust width of Predictor column


```

```{r PLOTTING ME fenoles, echo=FALSE, results='hold', warning=FALSE, message=FALSE}
plot_ME_variable(MEdata, fenoles)
```
